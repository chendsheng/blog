(function(t){if(typeof exports=="object"&&typeof module=="object")t(require("../../lib/codemirror"),require("../xml/xml"),require("../meta"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror","../xml/xml","../meta"],t);else t(CodeMirror)})(function(K){"use strict";K.defineMode("markdown",function(n,p){var r=K.modes.hasOwnProperty("xml");var v=K.getMode(n,r?{name:"xml",htmlMode:true}:"text/plain");function l(t){if(K.findModeByName){var e=K.findModeByName(t);if(e)t=e.mime||e.mimes[0]}var i=K.getMode(n,t);return i.name=="null"?null:i}if(p.highlightFormatting===undefined)p.highlightFormatting=false;if(p.maxBlockquoteDepth===undefined)p.maxBlockquoteDepth=0;if(p.underscoresBreakWords===undefined)p.underscoresBreakWords=true;if(p.fencedCodeBlocks===undefined)p.fencedCodeBlocks=false;if(p.taskLists===undefined)p.taskLists=false;if(p.strikethrough===undefined)p.strikethrough=false;var x=0;var a="header",f="comment",o="quote",s="variable-2",u="variable-3",h="keyword",g="hr",S="tag",m="formatting",L="link",F="link",c="link",b="string",d="em",k="strong",q="strikethrough";var M=/^([*\-=_])(?:\s*\1){2,}\s*$/,w=/^[*\-+]\s+/,C=/^[0-9]+\.\s+/,D=/^\[(x| )\](?=\s)/,j=/^#+/,E=/^(?:\={1,}|-{1,})$/,W=/^[^#!\[\]*_\\<>` "'(~]+/;function H(t,e,i){e.f=e.inline=i;return i(t,e)}function U(t,e,i){e.f=e.block=i;return i(t,e)}function T(t){t.linkTitle=false;t.em=false;t.strong=false;t.strikethrough=false;t.quote=0;if(!r&&t.f==y){t.f=$;t.block=B}t.trailingSpace=0;t.trailingSpaceNewLine=false;t.thisLineHasContent=false;return null}function B(t,e){var i=t.sol();var n=e.list!==false;if(e.list!==false&&e.indentationDiff>=0){if(e.indentationDiff<4){e.indentation-=e.indentationDiff}e.list=null}else if(e.list!==false&&e.indentation>0){e.list=null;e.listDepth=Math.floor(e.indentation/4)}else if(e.list!==false){e.list=false;e.listDepth=0}var r=null;if(e.indentationDiff>=4){e.indentation-=4;t.skipToEnd();return f}else if(t.eatSpace()){return null}else if(r=t.match(j)){e.header=r[0].length<=6?r[0].length:6;if(p.highlightFormatting)e.formatting="header";e.f=e.inline;return _(e)}else if(e.prevLineHasContent&&(r=t.match(E))){e.header=r[0].charAt(0)=="="?1:2;if(p.highlightFormatting)e.formatting="header";e.f=e.inline;return _(e)}else if(t.eat(">")){e.indentation++;e.quote=i?1:e.quote+1;if(p.highlightFormatting)e.formatting="quote";t.eatSpace();return _(e)}else if(t.peek()==="["){return H(t,e,P)}else if(t.match(M,true)){return g}else if((!e.prevLineHasContent||n)&&(t.match(w,false)||t.match(C,false))){var a=null;if(t.match(w,true)){a="ul"}else{t.match(C,true);a="ol"}e.indentation+=4;e.list=true;e.listDepth++;if(p.taskLists&&t.match(D,false)){e.taskList=true}e.f=e.inline;if(p.highlightFormatting)e.formatting=["list","list-"+a];return _(e)}else if(p.fencedCodeBlocks&&t.match(/^```[ \t]*([\w+#]*)/,true)){e.localMode=l(RegExp.$1);if(e.localMode)e.localState=e.localMode.startState();e.f=e.block=R;if(p.highlightFormatting)e.formatting="code-block";e.code=true;return _(e)}return H(t,e,e.inline)}function y(t,e){var i=v.token(t,e.htmlState);if(r&&e.htmlState.tagStart===null&&!e.htmlState.context||e.md_inside&&t.current().indexOf(">")>-1){e.f=$;e.block=B;e.htmlState=null}return i}function R(t,e){if(t.sol()&&t.match("```",false)){e.localMode=e.localState=null;e.f=e.block=A;return null}else if(e.localMode){return e.localMode.token(t,e.localState)}else{t.skipToEnd();return f}}function A(t,e){t.match("```");e.block=B;e.f=$;if(p.highlightFormatting)e.formatting="code-block";e.code=true;var i=_(e);e.code=false;return i}function _(t){var e=[];if(t.formatting){e.push(m);if(typeof t.formatting==="string")t.formatting=[t.formatting];for(var i=0;i<t.formatting.length;i++){e.push(m+"-"+t.formatting[i]);if(t.formatting[i]==="header"){e.push(m+"-"+t.formatting[i]+"-"+t.header)}if(t.formatting[i]==="quote"){if(!p.maxBlockquoteDepth||p.maxBlockquoteDepth>=t.quote){e.push(m+"-"+t.formatting[i]+"-"+t.quote)}else{e.push("error")}}}}if(t.taskOpen){e.push("meta");return e.length?e.join(" "):null}if(t.taskClosed){e.push("property");return e.length?e.join(" "):null}if(t.linkHref){e.push(b);return e.length?e.join(" "):null}if(t.strong){e.push(k)}if(t.em){e.push(d)}if(t.strikethrough){e.push(q)}if(t.linkText){e.push(c)}if(t.code){e.push(f)}if(t.header){e.push(a);e.push(a+"-"+t.header)}if(t.quote){e.push(o);if(!p.maxBlockquoteDepth||p.maxBlockquoteDepth>=t.quote){e.push(o+"-"+t.quote)}else{e.push(o+"-"+p.maxBlockquoteDepth)}}if(t.list!==false){var n=(t.listDepth-1)%3;if(!n){e.push(s)}else if(n===1){e.push(u)}else{e.push(h)}}if(t.trailingSpaceNewLine){e.push("trailing-space-new-line")}else if(t.trailingSpace){e.push("trailing-space-"+(t.trailingSpace%2?"a":"b"))}return e.length?e.join(" "):null}function t(t,e){if(t.match(W,true)){return _(e)}return undefined}function $(t,e){var i=e.text(t,e);if(typeof i!=="undefined")return i;if(e.list){e.list=null;return _(e)}if(e.taskList){var n=t.match(D,true)[1]!=="x";if(n)e.taskOpen=true;else e.taskClosed=true;if(p.highlightFormatting)e.formatting="task";e.taskList=false;return _(e)}e.taskOpen=false;e.taskClosed=false;if(e.header&&t.match(/^#+$/,true)){if(p.highlightFormatting)e.formatting="header";return _(e)}var r=t.sol();var a=t.next();if(a==="\\"){t.next();if(p.highlightFormatting){var l=_(e);return l?l+" formatting-escape":"formatting-escape"}}if(e.linkTitle){e.linkTitle=false;var f=a;if(a==="("){f=")"}f=(f+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");var o="^\\s*(?:[^"+f+"\\\\]+|\\\\\\\\|\\\\.)"+f;if(t.match(new RegExp(o),true)){return b}}if(a==="`"){var s=e.formatting;if(p.highlightFormatting)e.formatting="code";var u=_(e);var h=t.pos;t.eatWhile("`");var g=1+t.pos-h;if(!e.code){x=g;e.code=true;return _(e)}else{if(g===x){e.code=false;return u}e.formatting=s;return _(e)}}else if(e.code){return _(e)}if(a==="!"&&t.match(/\[[^\]]*\] ?(?:\(|\[)/,false)){t.match(/\[[^\]]*\]/);e.inline=e.f=O;return S}if(a==="["&&t.match(/.*\](\(.*\)| ?\[.*\])/,false)){e.linkText=true;if(p.highlightFormatting)e.formatting="link";return _(e)}if(a==="]"&&e.linkText&&t.match(/\(.*\)| ?\[.*\]/,false)){if(p.highlightFormatting)e.formatting="link";var l=_(e);e.linkText=false;e.inline=e.f=O;return l}if(a==="<"&&t.match(/^(https?|ftps?):\/\/(?:[^\\>]|\\.)+>/,false)){e.f=e.inline=N;if(p.highlightFormatting)e.formatting="link";var l=_(e);if(l){l+=" "}else{l=""}return l+L}if(a==="<"&&t.match(/^[^> \\]+@(?:[^\\>]|\\.)+>/,false)){e.f=e.inline=N;if(p.highlightFormatting)e.formatting="link";var l=_(e);if(l){l+=" "}else{l=""}return l+F}if(a==="<"&&t.match(/^\w/,false)){if(t.string.indexOf(">")!=-1){var m=t.string.substring(1,t.string.indexOf(">"));if(/markdown\s*=\s*('|"){0,1}1('|"){0,1}/.test(m)){e.md_inside=true}}t.backUp(1);e.htmlState=K.startState(v);return U(t,e,y)}if(a==="<"&&t.match(/^\/\w*?>/)){e.md_inside=false;return"tag"}var c=false;if(!p.underscoresBreakWords){if(a==="_"&&t.peek()!=="_"&&t.match(/(\w)/,false)){var d=t.pos-2;if(d>=0){var k=t.string.charAt(d);if(k!=="_"&&k.match(/(\w)/,false)){c=true}}}}if(a==="*"||a==="_"&&!c){if(r&&t.peek()===" "){}else if(e.strong===a&&t.eat(a)){if(p.highlightFormatting)e.formatting="strong";var u=_(e);e.strong=false;return u}else if(!e.strong&&t.eat(a)){e.strong=a;if(p.highlightFormatting)e.formatting="strong";return _(e)}else if(e.em===a){if(p.highlightFormatting)e.formatting="em";var u=_(e);e.em=false;return u}else if(!e.em){e.em=a;if(p.highlightFormatting)e.formatting="em";return _(e)}}else if(a===" "){if(t.eat("*")||t.eat("_")){if(t.peek()===" "){return _(e)}else{t.backUp(1)}}}if(p.strikethrough){if(a==="~"&&t.eatWhile(a)){if(e.strikethrough){if(p.highlightFormatting)e.formatting="strikethrough";var u=_(e);e.strikethrough=false;return u}else if(t.match(/^[^\s]/,false)){e.strikethrough=true;if(p.highlightFormatting)e.formatting="strikethrough";return _(e)}}else if(a===" "){if(t.match(/^~~/,true)){if(t.peek()===" "){return _(e)}else{t.backUp(2)}}}}if(a===" "){if(t.match(/ +$/,false)){e.trailingSpace++}else if(e.trailingSpace){e.trailingSpaceNewLine=true}}return _(e)}function N(t,e){var i=t.next();if(i===">"){e.f=e.inline=$;if(p.highlightFormatting)e.formatting="link";var n=_(e);if(n){n+=" "}else{n=""}return n+L}t.match(/^[^>]+/,true);return L}function O(t,e){if(t.eatSpace()){return null}var i=t.next();if(i==="("||i==="["){e.f=e.inline=I(i==="("?")":"]");if(p.highlightFormatting)e.formatting="link-string";e.linkHref=true;return _(e)}return"error"}function I(r){return function(t,e){var i=t.next();if(i===r){e.f=e.inline=$;if(p.highlightFormatting)e.formatting="link-string";var n=_(e);e.linkHref=false;return n}if(t.match(J(r),true)){t.backUp(1)}e.linkHref=true;return _(e)}}function P(t,e){if(t.match(/^[^\]]*\]:/,false)){e.f=z;t.next();if(p.highlightFormatting)e.formatting="link";e.linkText=true;return _(e)}return H(t,e,$)}function z(t,e){if(t.match(/^\]:/,true)){e.f=e.inline=G;if(p.highlightFormatting)e.formatting="link";var i=_(e);e.linkText=false;return i}t.match(/^[^\]]+/,true);return c}function G(t,e){if(t.eatSpace()){return null}t.match(/^[^\s]+/,true);if(t.peek()===undefined){e.linkTitle=true}else{t.match(/^(?:\s+(?:"(?:[^"\\]|\\\\|\\.)+"|'(?:[^'\\]|\\\\|\\.)+'|\((?:[^)\\]|\\\\|\\.)+\)))?/,true)}e.f=e.inline=$;return b}var e=[];function J(t){if(!e[t]){t=(t+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");e[t]=new RegExp("^(?:[^\\\\]|\\\\.)*?("+t+")")}return e[t]}var i={startState:function(){return{f:B,prevLineHasContent:false,thisLineHasContent:false,block:B,htmlState:null,indentation:0,inline:$,text:t,formatting:false,linkText:false,linkHref:false,linkTitle:false,em:false,strong:false,header:0,taskList:false,list:false,listDepth:0,quote:0,trailingSpace:0,trailingSpaceNewLine:false,strikethrough:false}},copyState:function(t){return{f:t.f,prevLineHasContent:t.prevLineHasContent,thisLineHasContent:t.thisLineHasContent,block:t.block,htmlState:t.htmlState&&K.copyState(v,t.htmlState),indentation:t.indentation,localMode:t.localMode,localState:t.localMode?K.copyState(t.localMode,t.localState):null,inline:t.inline,text:t.text,formatting:false,linkTitle:t.linkTitle,em:t.em,strong:t.strong,strikethrough:t.strikethrough,header:t.header,taskList:t.taskList,list:t.list,listDepth:t.listDepth,quote:t.quote,trailingSpace:t.trailingSpace,trailingSpaceNewLine:t.trailingSpaceNewLine,md_inside:t.md_inside}},token:function(t,e){e.formatting=false;if(t.sol()){var i=!!e.header;e.header=0;if(t.match(/^\s*$/,true)||i){e.prevLineHasContent=false;T(e);return i?this.token(t,e):null}else{e.prevLineHasContent=e.thisLineHasContent;e.thisLineHasContent=true}e.taskList=false;e.code=false;e.trailingSpace=0;e.trailingSpaceNewLine=false;e.f=e.block;var n=t.match(/^\s*/,true)[0].replace(/\t/g,"    ").length;var r=Math.floor((n-e.indentation)/4)*4;if(r>4)r=4;var a=e.indentation+r;e.indentationDiff=a-e.indentation;e.indentation=a;if(n>0)return null}return e.f(t,e)},innerMode:function(t){if(t.block==y)return{state:t.htmlState,mode:v};if(t.localState)return{state:t.localState,mode:t.localMode};return{state:t,mode:i}},blankLine:T,getType:_,fold:"markdown"};return i},"xml");K.defineMIME("text/x-markdown","markdown")});