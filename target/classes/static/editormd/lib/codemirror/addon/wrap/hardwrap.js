(function(r){if(typeof exports=="object"&&typeof module=="object")r(require("../../lib/codemirror"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror"],r);else r(CodeMirror)})(function(w){"use strict";var x=w.Pos;function l(r,e,t){var n=t.paragraphStart||r.getHelper(e,"paragraphStart");for(var a=e.line,o=r.firstLine();a>o;--a){var i=r.getLine(a);if(n&&n.test(i))break;if(!/\S/.test(i)){++a;break}}var f=t.paragraphEnd||r.getHelper(e,"paragraphEnd");for(var l=e.line+1,s=r.lastLine();l<=s;++l){var i=r.getLine(l);if(f&&f.test(i)){++l;break}if(!/\S/.test(i))break}return{from:a,to:l}}function S(r,e,t,n){for(var a=e;a>0;--a)if(t.test(r.slice(a-1,a+1)))break;if(a==0)a=e;var o=a;if(n)while(r.charAt(o-1)==" ")--o;return{from:o,to:a}}function s(t,r,e,n){r=t.clipPos(r);e=t.clipPos(e);var a=n.column||80;var o=n.wrapOn||/\s\S|-[^\.\d]/;var i=n.killTrailingSpace!==false;var f=[],l="",s=r.line;var h=t.getRange(r,e,false);if(!h.length)return null;var c=h[0].match(/^[ \t]*/)[0];for(var g=0;g<h.length;++g){var p=h[g],v=l.length,u=0;if(l&&p&&!o.test(l.charAt(l.length-1)+p.charAt(0))){l+=" ";u=1}var m="";if(g){m=p.match(/^\s*/)[0];p=p.slice(m.length)}l+=p;if(g){var d=l.length>a&&c==m&&S(l,a,o,i);if(!d||d.from!=v||d.to!=v+u){f.push({text:[u?" ":""],from:x(s,v),to:x(s+1,m.length)})}else{l=c+p;++s}}while(l.length>a){var b=S(l,a,o,i);f.push({text:["",c],from:x(s,b.from),to:x(s,b.to)});l=c+l.slice(b.to);++s}}if(f.length)t.operation(function(){for(var r=0;r<f.length;++r){var e=f[r];t.replaceRange(e.text,e.from,e.to)}});return f.length?{from:f[0].from,to:w.changeEnd(f[f.length-1])}:null}w.defineExtension("wrapParagraph",function(r,e){e=e||{};if(!r)r=this.getCursor();var t=l(this,r,e);return s(this,x(t.from,0),x(t.to-1),e)});w.commands.wrapLines=function(i){i.operation(function(){var r=i.listSelections(),e=i.lastLine()+1;for(var t=r.length-1;t>=0;t--){var n=r[t],a;if(n.empty()){var o=l(i,n.head,{});a={from:x(o.from,0),to:x(o.to-1)}}else{a={from:n.from(),to:n.to()}}if(a.to.line>=e)continue;e=a.from.line;s(i,a.from,a.to,{})}})};w.defineExtension("wrapRange",function(r,e,t){return s(this,r,e,t||{})});w.defineExtension("wrapParagraphsInRange",function(r,e,t){t=t||{};var n=this,a=[];for(var o=r.line;o<=e.line;){var i=l(n,x(o,0),t);a.push(i);o=i.to}var f=false;if(a.length)n.operation(function(){for(var r=a.length-1;r>=0;--r)f=f||s(n,x(a[r].from,0),x(a[r].to-1),t)});return f})});