(function(t){if(typeof exports=="object"&&typeof module=="object")t(require("../../lib/codemirror"),require("./foldcode"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror","./foldcode"],t);else t(CodeMirror)})(function(r){"use strict";r.defineOption("foldGutter",false,function(t,o,e){if(e&&e!=r.Init){t.clearGutter(t.state.foldGutter.options.gutter);t.state.foldGutter=null;t.off("gutterClick",a);t.off("change",s);t.off("viewportChange",p);t.off("fold",m);t.off("unfold",m);t.off("swapDoc",u)}if(o){t.state.foldGutter=new n(i(o));u(t);t.on("gutterClick",a);t.on("change",s);t.on("viewportChange",p);t.on("fold",m);t.on("unfold",m);t.on("swapDoc",u)}});var d=r.Pos;function n(t){this.options=t;this.from=this.to=0}function i(t){if(t===true)t={};if(t.gutter==null)t.gutter="CodeMirror-foldgutter";if(t.indicatorOpen==null)t.indicatorOpen="CodeMirror-foldgutter-open";if(t.indicatorFolded==null)t.indicatorFolded="CodeMirror-foldgutter-folded";return t}function l(t,o){var e=t.findMarksAt(d(o));for(var r=0;r<e.length;++r)if(e[r].__isFold&&e[r].find().from.line==o)return true}function c(t){if(typeof t=="string"){var o=document.createElement("div");o.className=t+" CodeMirror-guttermarker-subtle";return o}else{return t.cloneNode(true)}}function f(n,t,o){var i=n.state.foldGutter.options,f=t;var u=n.foldOption(i,"minFoldSize");var a=n.foldOption(i,"rangeFinder");n.eachLine(t,o,function(t){var o=null;if(l(n,f)){o=c(i.indicatorFolded)}else{var e=d(f,0);var r=a&&a(n,e);if(r&&r.to.line-r.from.line>=u)o=c(i.indicatorOpen)}n.setGutterMarker(t,i.gutter,o);++f})}function u(t){var o=t.getViewport(),e=t.state.foldGutter;if(!e)return;t.operation(function(){f(t,o.from,o.to)});e.from=o.from;e.to=o.to}function a(t,o,e){var r=t.state.foldGutter;if(!r)return;var n=r.options;if(e!=n.gutter)return;t.foldCode(d(o,0),n.rangeFinder)}function s(t){var o=t.state.foldGutter;if(!o)return;var e=o.options;o.from=o.to=0;clearTimeout(o.changeUpdate);o.changeUpdate=setTimeout(function(){u(t)},e.foldOnChangeTimeSpan||600)}function p(o){var e=o.state.foldGutter;if(!e)return;var t=e.options;clearTimeout(e.changeUpdate);e.changeUpdate=setTimeout(function(){var t=o.getViewport();if(e.from==e.to||t.from-e.to>20||e.from-t.to>20){u(o)}else{o.operation(function(){if(t.from<e.from){f(o,t.from,e.from);e.from=t.from}if(t.to>e.to){f(o,e.to,t.to);e.to=t.to}})}},t.updateViewportTimeSpan||400)}function m(t,o){var e=t.state.foldGutter;if(!e)return;var r=o.line;if(r>=e.from&&r<e.to)f(t,r,r+1)}});