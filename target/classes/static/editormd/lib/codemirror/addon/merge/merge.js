(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../../lib/codemirror"),require("diff_match_patch"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror","diff_match_patch"],e);else e(CodeMirror,diff_match_patch)})(function(p,e){"use strict";var y=p.Pos;var k="http://www.w3.org/2000/svg";function C(e,r){this.mv=e;this.type=r;this.classes=r=="left"?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}C.prototype={constructor:C,init:function(e,r,t){this.edit=this.mv.edit;this.orig=p(e,B({value:r,readOnly:!this.mv.options.allowEditingOriginals},B(t)));this.diff=b(m(r),m(t.value));this.chunks=E(this.diff);this.diffOutOfDate=this.dealigned=false;this.showDifferences=t.showDifferences!==false;this.forceUpdate=i(this);f(this,true,false);o(this)},setShowDifferences:function(e){e=e!==false;if(e!=this.showDifferences){this.showDifferences=e;this.forceUpdate("full")}}};function s(e){if(e.diffOutOfDate){e.diff=b(e.orig.getValue(),e.edit.getValue());e.chunks=E(e.diff);e.diffOutOfDate=false;p.signal(e.edit,"updateDiff",e.diff)}}var T=false;function i(t){var i={from:0,to:0,marked:[]};var o={from:0,to:0,marked:[]};var r,n=false;function f(e){T=true;n=false;if(e=="full"){if(t.svg)A(t.svg);if(t.copyButtons)A(t.copyButtons);c(t.edit,i.marked,t.classes);c(t.orig,o.marked,t.classes);i.from=i.to=o.from=o.to=0}s(t);if(t.showDifferences){u(t.edit,t.diff,i,DIFF_INSERT,t.classes);u(t.orig,t.diff,o,DIFF_DELETE,t.classes)}w(t);if(t.mv.options.connect=="align")M(t);T=false}function a(e){if(T)return;t.dealigned=true;l(e)}function l(e){if(T||n)return;clearTimeout(r);if(e===true)n=true;r=setTimeout(f,e===true?20:250)}function e(e,r){if(!t.diffOutOfDate){t.diffOutOfDate=true;i.from=i.to=o.from=o.to=0}a(r.text.length-1!=r.to.line-r.from.line)}t.edit.on("change",e);t.orig.on("change",e);t.edit.on("markerAdded",a);t.edit.on("markerCleared",a);t.orig.on("markerAdded",a);t.orig.on("markerCleared",a);t.edit.on("viewportChange",function(){l(false)});t.orig.on("viewportChange",function(){l(false)});f();return f}function o(e){e.edit.on("scroll",function(){n(e,DIFF_INSERT)&&w(e)});e.orig.on("scroll",function(){n(e,DIFF_DELETE)&&w(e)})}function n(e,r){if(e.diffOutOfDate)return false;if(!e.lockScroll)return true;var t,i,o=+new Date;if(r==DIFF_INSERT){t=e.edit;i=e.orig}else{t=e.orig;i=e.edit}if(t.state.scrollSetBy==e&&(t.state.scrollSetAt||0)+50>o)return false;var n=t.getScrollInfo();if(e.mv.options.connect=="align"){d=n.top}else{var f=.5*n.clientHeight,a=n.top+f;var l=t.lineAtHeight(a,"local");var s=H(e.chunks,l,r==DIFF_INSERT);var c=F(t,r==DIFF_INSERT?s.edit:s.orig);var u=F(i,r==DIFF_INSERT?s.orig:s.edit);var h=(a-c.top)/(c.bot-c.top);var d=u.top-f+h*(u.bot-u.top);var g,v;if(d>n.top&&(v=n.top/f)<1){d=d*v+n.top*(1-v)}else if((g=n.height-n.clientHeight-n.top)<f){var m=i.getScrollInfo();var p=m.height-m.clientHeight-d;if(p>g&&(v=g/f)<1)d=d*v+(m.height-m.clientHeight-g)*(1-v)}}i.scrollTo(n.left,d);i.state.scrollSetAt=o;i.state.scrollSetBy=e;return true}function F(e,r){var t=r.after;if(t==null)t=e.lastLine()+1;return{top:e.heightAtLine(r.before||0,"local"),bot:e.heightAtLine(t,"local")}}function f(e,r,t){e.lockScroll=r;if(r&&t!=false)n(e,DIFF_INSERT)&&w(e);e.lockButton.innerHTML=r?"⇛⇚":"⇛&nbsp;&nbsp;⇚"}function c(e,r,t){for(var i=0;i<r.length;++i){var o=r[i];if(o instanceof p.TextMarker){o.clear()}else if(o.parent){e.removeLineClass(o,"background",t.chunk);e.removeLineClass(o,"background",t.start);e.removeLineClass(o,"background",t.end)}}r.length=0}function u(e,r,t,i,o){var n=e.getViewport();e.operation(function(){if(t.from==t.to||n.from-t.to>20||t.from-n.to>20){c(e,t.marked,o);a(e,r,i,t.marked,n.from,n.to,o);t.from=n.from;t.to=n.to}else{if(n.from<t.from){a(e,r,i,t.marked,n.from,t.from,o);t.from=n.from}if(n.to>t.to){a(e,r,i,t.marked,t.to,n.to,o);t.to=n.to}}})}function a(f,e,r,a,l,s,c){var t=y(0,0);var i=y(l,0),o=f.clipPos(y(s-1));var n=r==DIFF_DELETE?c.del:c.insert;function u(e,r){var t=Math.max(l,e),i=Math.min(s,r);for(var o=t;o<i;++o){var n=f.addLineClass(o,"background",c.chunk);if(o==e)f.addLineClass(n,"background",c.start);if(o==r-1)f.addLineClass(n,"background",c.end);a.push(n)}if(e==r&&t==r&&i==r){if(t)a.push(f.addLineClass(t-1,"background",c.end));else a.push(f.addLineClass(t,"background",c.start))}}var h=0;for(var d=0;d<e.length;++d){var g=e[d],v=g[0],m=g[1];if(v==DIFF_EQUAL){var p=t.line+(O(e,d)?0:1);R(t,m);var k=t.line+(S(e,d)?1:0);if(k>p){if(d)u(h,p);h=k}}else{if(v==r){var C=R(t,m,true);var T=j(i,t),F=z(o,C);if(!q(T,F))a.push(f.markText(T,F,{className:n}));t=C}}}if(h<=t.line)u(h,t.line+1)}function w(e){if(!e.showDifferences)return;if(e.svg){A(e.svg);var r=e.gap.offsetWidth;x(e.svg,"width",r,"height",e.gap.offsetHeight)}if(e.copyButtons)A(e.copyButtons);var t=e.edit.getViewport(),i=e.orig.getViewport();var o=e.edit.getScrollInfo().top,n=e.orig.getScrollInfo().top;for(var f=0;f<e.chunks.length;f++){var a=e.chunks[f];if(a.editFrom<=t.to&&a.editTo>=t.from&&a.origFrom<=i.to&&a.origTo>=i.from)V(e,a,n,o,r)}}function h(e,r){var t=0,i=0;for(var o=0;o<r.length;o++){var n=r[o];if(n.editTo>e&&n.editFrom<=e)return null;if(n.editFrom>e)break;t=n.editTo;i=n.origTo}return i+(e-t)}function d(e,r){var t=[];for(var i=0;i<e.chunks.length;i++){var o=e.chunks[i];t.push([o.origTo,o.editTo,r?h(o.editTo,r.chunks):null])}if(r){for(var i=0;i<r.chunks.length;i++){var o=r.chunks[i];for(var n=0;n<t.length;n++){var f=t[n];if(f[1]==o.editTo){n=-1;break}else if(f[1]>o.editTo){break}}if(n>-1)t.splice(n-1,0,[h(o.editTo,e.chunks),o.editTo,o.origTo])}}return t}function M(e,r){if(!e.dealigned&&!r)return;if(!e.orig.curOp)return e.orig.operation(function(){M(e,r)});e.dealigned=false;var t=e.mv.left==e?e.mv.right:e.mv.left;if(t){s(t);t.dealigned=false}var i=d(e,t);var o=e.mv.aligners;for(var n=0;n<o.length;n++)o[n].clear();o.length=0;var f=[e.orig,e.edit],a=[];if(t)f.push(t.orig);for(var n=0;n<f.length;n++)a.push(f[n].getScrollInfo().top);for(var l=0;l<i.length;l++)g(f,i[l],o);for(var n=0;n<f.length;n++)f[n].scrollTo(null,a[n])}function g(e,r,t){var i=0,o=[];for(var n=0;n<e.length;n++)if(r[n]!=null){var f=e[n].heightAtLine(r[n],"local");o[n]=f;i=Math.max(i,f)}for(var n=0;n<e.length;n++)if(r[n]!=null){var a=i-o[n];if(a>1)t.push(l(e[n],r[n],a))}}function l(e,r,t){var i=true;if(r>e.lastLine()){r--;i=false}var o=document.createElement("div");o.className="CodeMirror-merge-spacer";o.style.height=t+"px";o.style.minWidth="1px";return e.addLineWidget(r,o,{height:t,above:i})}function V(e,r,t,i,o){var n=e.type=="left";var f=e.orig.heightAtLine(r.origFrom,"local")-t;if(e.svg){var a=f;var l=e.edit.heightAtLine(r.editFrom,"local")-i;if(n){var s=a;a=l;l=s}var c=e.orig.heightAtLine(r.origTo,"local")-t;var u=e.edit.heightAtLine(r.editTo,"local")-i;if(n){var s=c;c=u;u=s}var h=" C "+o/2+" "+l+" "+o/2+" "+a+" "+(o+2)+" "+a;var d=" C "+o/2+" "+c+" "+o/2+" "+u+" -1 "+u;x(e.svg.appendChild(document.createElementNS(k,"path")),"d","M -1 "+l+h+" L "+(o+2)+" "+c+d+" z","class",e.classes.connect)}if(e.copyButtons){var g=e.copyButtons.appendChild(_("div",e.type=="left"?"⇝":"⇜","CodeMirror-merge-copy"));var v=e.mv.options.allowEditingOriginals;g.title=v?"Push to left":"Revert chunk";g.chunk=r;g.style.top=f+"px";if(v){var m=e.orig.heightAtLine(r.editFrom,"local")-i;var p=e.copyButtons.appendChild(_("div",e.type=="right"?"⇝":"⇜","CodeMirror-merge-copy-reverse"));p.title="Push to right";p.chunk={editFrom:r.origFrom,editTo:r.origTo,origFrom:r.editFrom,origTo:r.editTo};p.style.top=m+"px";e.type=="right"?p.style.left="2px":p.style.right="2px"}}}function v(e,r,t,i){if(e.diffOutOfDate)return;r.replaceRange(t.getRange(y(i.origFrom,0),y(i.origTo,0)),y(i.editFrom,0),y(i.editTo,0))}var D=p.MergeView=function(e,r){if(!(this instanceof D))return new D(e,r);this.options=r;var t=r.origLeft,i=r.origRight==null?r.orig:r.origRight;var o=t!=null,n=i!=null;var f=1+(o?1:0)+(n?1:0);var a=[],l=this.left=null,s=this.right=null;var c=this;if(o){l=this.left=new C(this,"left");var u=_("div",null,"CodeMirror-merge-pane");a.push(u);a.push(L(l))}var h=_("div",null,"CodeMirror-merge-pane");a.push(h);if(n){s=this.right=new C(this,"right");a.push(L(s));var d=_("div",null,"CodeMirror-merge-pane");a.push(d)}(n?d:h).className+=" CodeMirror-merge-pane-rightmost";a.push(_("div",null,null,"height: 0; clear: both;"));var g=this.wrap=e.appendChild(_("div",a,"CodeMirror-merge CodeMirror-merge-"+f+"pane"));this.edit=p(h,B(r));if(l)l.init(u,t,r);if(s)s.init(d,i,r);if(r.collapseIdentical){T=true;this.editor().operation(function(){W(c,r.collapseIdentical)});T=false}if(r.connect=="align"){this.aligners=[];M(this.left||this.right,true)}var v=function(){if(l)w(l);if(s)w(s)};p.on(window,"resize",v);var m=setInterval(function(){for(var e=g.parentNode;e&&e!=document.body;e=e.parentNode){}if(!e){clearInterval(m);p.off(window,"resize",v)}},5e3)};function L(t){var e=t.lockButton=_("div",null,"CodeMirror-merge-scrolllock");e.title="Toggle locked scrolling";var r=_("div",[e],"CodeMirror-merge-scrolllock-wrap");p.on(e,"click",function(){f(t,!t.lockScroll)});var i=[r];if(t.mv.options.revertButtons!==false){t.copyButtons=_("div",null,"CodeMirror-merge-copybuttons-"+t.type);p.on(t.copyButtons,"click",function(e){var r=e.target||e.srcElement;if(!r.chunk)return;if(r.className=="CodeMirror-merge-copy-reverse"){v(t,t.orig,t.edit,r.chunk);return}v(t,t.edit,t.orig,r.chunk)});i.unshift(t.copyButtons)}if(t.mv.options.connect!="align"){var o=document.createElementNS&&document.createElementNS(k,"svg");if(o&&!o.createSVGRect)o=null;t.svg=o;if(o)i.push(o)}return t.gap=_("div",i,"CodeMirror-merge-gap")}D.prototype={constuctor:D,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(e){if(this.right)this.right.setShowDifferences(e);if(this.left)this.left.setShowDifferences(e)},rightChunks:function(){if(this.right){s(this.right);return this.right.chunks}},leftChunks:function(){if(this.left){s(this.left);return this.left.chunks}}};function m(e){if(typeof e=="string")return e;else return e.getValue()}var I=new e;function b(e,r){var t=I.diff_main(e,r);I.diff_cleanupSemantic(t);for(var i=0;i<t.length;++i){var o=t[i];if(!o[1]){t.splice(i--,1)}else if(i&&t[i-1][0]==o[0]){t.splice(i--,1);t[i][1]+=o[1]}}return t}function E(e){var r=[];var t=0,i=0;var o=y(0,0),n=y(0,0);for(var f=0;f<e.length;++f){var a=e[f],l=a[0];if(l==DIFF_EQUAL){var s=O(e,f)?0:1;var c=o.line+s,u=n.line+s;R(o,a[1],null,n);var h=S(e,f)?1:0;var d=o.line+h,g=n.line+h;if(d>c){if(f)r.push({origFrom:i,origTo:u,editFrom:t,editTo:c});t=d;i=g}}else{R(l==DIFF_INSERT?o:n,a[1])}}if(t<=o.line||i<=n.line)r.push({origFrom:i,origTo:n.line+1,editFrom:t,editTo:o.line+1});return r}function S(e,r){if(r==e.length-1)return true;var t=e[r+1][1];if(t.length==1||t.charCodeAt(0)!=10)return false;if(r==e.length-2)return true;t=e[r+2][1];return t.length>1&&t.charCodeAt(0)==10}function O(e,r){if(r==0)return true;var t=e[r-1][1];if(t.charCodeAt(t.length-1)!=10)return false;if(r==1)return true;t=e[r-2][1];return t.charCodeAt(t.length-1)==10}function H(e,r,t){var i,o,n,f;for(var a=0;a<e.length;a++){var l=e[a];var s=t?l.editFrom:l.origFrom;var c=t?l.editTo:l.origTo;if(o==null){if(s>r){o=l.editFrom;f=l.origFrom}else if(c>r){o=l.editTo;f=l.origTo}}if(c<=r){i=l.editTo;n=l.origTo}else if(s<=r){i=l.editFrom;n=l.origFrom}}return{edit:{before:i,after:o},orig:{before:n,after:f}}}function P(e,r,t){e.addLineClass(r,"wrap","CodeMirror-merge-collapsed-line");var i=document.createElement("span");i.className="CodeMirror-merge-collapsed-widget";i.title="Identical text collapsed. Click to expand.";var o=e.markText(y(r,0),y(t-1),{inclusiveLeft:true,inclusiveRight:true,replacedWith:i,clearOnEnter:true});function n(){o.clear();e.removeLineClass(r,"wrap","CodeMirror-merge-collapsed-line")}i.addEventListener("click",n);return{mark:o,clear:n}}function U(e,r){var t=[];function i(){for(var e=0;e<t.length;e++)t[e].clear()}for(var o=0;o<r.length;o++){var n=r[o];var f=P(n.cm,n.line,n.line+e);t.push(f);f.mark.on("clear",i)}return t[0].mark}function N(e,r,t,i){for(var o=0;o<e.chunks.length;o++){var n=e.chunks[o];for(var f=n.editFrom-r;f<n.editTo+r;f++){var a=f+t;if(a>=0&&a<i.length)i[a]=false}}}function W(e,r){if(typeof r!="number")r=2;var t=[],i=e.editor(),o=i.firstLine();for(var n=o,f=i.lastLine();n<=f;n++)t.push(true);if(e.left)N(e.left,r,o,t);if(e.right)N(e.right,r,o,t);for(var a=0;a<t.length;a++){if(t[a]){var l=a+o;for(var s=1;a<t.length-1&&t[a+1];a++,s++){}if(s>r){var c=[{line:l,cm:i}];if(e.left)c.push({line:h(l,e.left.chunks),cm:e.left.orig});if(e.right)c.push({line:h(l,e.right.chunks),cm:e.right.orig});var u=U(s,c);if(e.options.onCollapse)e.options.onCollapse(e,l,s,u)}}}}function _(e,r,t,i){var o=document.createElement(e);if(t)o.className=t;if(i)o.style.cssText=i;if(typeof r=="string")o.appendChild(document.createTextNode(r));else if(r)for(var n=0;n<r.length;++n)o.appendChild(r[n]);return o}function A(e){for(var r=e.childNodes.length;r>0;--r)e.removeChild(e.firstChild)}function x(e){for(var r=1;r<arguments.length;r+=2)e.setAttribute(arguments[r],arguments[r+1])}function B(e,r){if(!r)r={};for(var t in e)if(e.hasOwnProperty(t))r[t]=e[t];return r}function R(e,r,t,i){var o=t?y(e.line,e.ch):e,n=0;for(;;){var f=r.indexOf("\n",n);if(f==-1)break;++o.line;if(i)++i.line;n=f+1}o.ch=(n?0:o.ch)+(r.length-n);if(i)i.ch=(n?0:i.ch)+(r.length-n);return o}function z(e,r){return(e.line-r.line||e.ch-r.ch)<0?e:r}function j(e,r){return(e.line-r.line||e.ch-r.ch)>0?e:r}function q(e,r){return e.line==r.line&&e.ch==r.ch}});