(function(t){if(typeof exports=="object"&&typeof module=="object")t(require("../../lib/codemirror"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror"],t);else t(CodeMirror)})(function(k){"use strict";var A="CodeMirror-hint";var T="CodeMirror-hint-active";k.showHint=function(t,e,i){if(!e)return t.showHint(i);if(i&&i.async)e.async=true;var n={hint:e};if(i)for(var o in i)n[o]=i[o];return t.showHint(n)};var s=0;function p(t,e,i,n){if(t.async){var o=++s;t(e,function(t){if(s==o)n(t)},i)}else{n(t(e,i))}}k.defineExtension("showHint",function(t){if(this.listSelections().length>1||this.somethingSelected())return;if(this.state.completionActive)this.state.completionActive.close();var e=this.state.completionActive=new n(this,t);var i=e.options.hint;if(!i)return;k.signal(this,"startCompletion",this);return p(i,this,e.options,function(t){e.showHints(t)})});function n(t,e){this.cm=t;this.options=this.buildOptions(e);this.widget=this.onClose=null}n.prototype={close:function(){if(!this.active())return;this.cm.state.completionActive=null;if(this.widget)this.widget.close();if(this.onClose)this.onClose();k.signal(this.cm,"endCompletion",this.cm)},active:function(){return this.cm.state.completionActive==this},pick:function(t,e){var i=t.list[e];if(i.hint)i.hint(this.cm,t,i);else this.cm.replaceRange(N(i),i.from||t.from,i.to||t.to,"complete");k.signal(t,"pick",i);this.close()},showHints:function(t){if(!t||!t.list.length||!this.active())return this.close();if(this.options.completeSingle&&t.list.length==1)this.pick(t,0);else this.showWidget(t)},showWidget:function(e){this.widget=new m(this,e);k.signal(e,"shown");var i=0,n=this,o;var s=this.options.closeCharacters;var r=this.cm.getCursor(),c=this.cm.getLine(r.line).length;var l=window.requestAnimationFrame||function(t){return setTimeout(t,1e3/60)};var t=window.cancelAnimationFrame||clearTimeout;function h(){if(o)return;o=true;n.close();n.cm.off("cursorActivity",d);if(e)k.signal(e,"close")}function f(){if(o)return;k.signal(e,"update");p(n.options.hint,n.cm,n.options,a)}function a(t){e=t;if(o)return;if(!e||!e.list.length)return h();if(n.widget)n.widget.close();n.widget=new m(n,e)}function u(){if(i){t(i);i=0}}function d(){u();var t=n.cm.getCursor(),e=n.cm.getLine(t.line);if(t.line!=r.line||e.length-t.ch!=c-r.ch||t.ch<r.ch||n.cm.somethingSelected()||t.ch&&s.test(e.charAt(t.ch-1))){n.close()}else{i=l(f);if(n.widget)n.widget.close()}}this.cm.on("cursorActivity",d);this.onClose=h},buildOptions:function(t){var e=this.cm.options.hintOptions;var i={};for(var n in o)i[n]=o[n];if(e)for(var n in e)if(e[n]!==undefined)i[n]=e[n];if(t)for(var n in t)if(t[n]!==undefined)i[n]=t[n];return i}};function N(t){if(typeof t=="string")return t;else return t.text}function O(t,n){var o={Up:function(){n.moveFocus(-1)},Down:function(){n.moveFocus(1)},PageUp:function(){n.moveFocus(-n.menuSize()+1,true)},PageDown:function(){n.moveFocus(n.menuSize()-1,true)},Home:function(){n.setFocus(0)},End:function(){n.setFocus(n.length-1)},Enter:n.pick,Tab:n.pick,Esc:n.close};var e=t.options.customKeys;var s=e?{}:o;function i(t,e){var i;if(typeof e!="string")i=function(t){return e(t,n)};else if(o.hasOwnProperty(e))i=o[e];else i=e;s[t]=i}if(e)for(var r in e)if(e.hasOwnProperty(r))i(r,e[r]);var c=t.options.extraKeys;if(c)for(var r in c)if(c.hasOwnProperty(r))i(r,c[r]);return s}function S(t,e){while(e&&e!=t){if(e.nodeName.toUpperCase()==="LI"&&e.parentNode==t)return e;e=e.parentNode}}function m(o,t){this.completion=o;this.data=t;var i=this,s=o.cm;var r=this.hints=document.createElement("ul");r.className="CodeMirror-hints";this.selectedHint=t.selectedHint||0;var e=t.list;for(var n=0;n<e.length;++n){var c=r.appendChild(document.createElement("li")),l=e[n];var h=A+(n!=this.selectedHint?"":" "+T);if(l.className!=null)h=l.className+" "+h;c.className=h;if(l.render)l.render(c,t,l);else c.appendChild(document.createTextNode(l.displayText||N(l)));c.hintId=n}var f=s.cursorCoords(o.options.alignWithWord?t.from:null);var a=f.left,u=f.bottom,d=true;r.style.left=a+"px";r.style.top=u+"px";var p=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth);var m=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(o.options.container||document.body).appendChild(r);var g=r.getBoundingClientRect(),v=g.bottom-m;if(v>0){var w=g.bottom-g.top,y=f.top-(f.bottom-g.top);if(y-w>0){r.style.top=(u=f.top-w)+"px";d=false}else if(w>m){r.style.height=m-5+"px";r.style.top=(u=f.bottom-g.top)+"px";var C=s.getCursor();if(t.from.ch!=C.ch){f=s.cursorCoords(C);r.style.left=(a=f.left)+"px";g=r.getBoundingClientRect()}}}var H=g.right-p;if(H>0){if(g.right-g.left>p){r.style.width=p-5+"px";H-=g.right-g.left-p}r.style.left=(a=f.left-H)+"px"}s.addKeyMap(this.keyMap=O(o,{moveFocus:function(t,e){i.changeActive(i.selectedHint+t,e)},setFocus:function(t){i.changeActive(t)},menuSize:function(){return i.screenAmount()},length:e.length,close:function(){o.close()},pick:function(){i.pick()},data:t}));if(o.options.closeOnUnfocus){var b;s.on("blur",this.onBlur=function(){b=setTimeout(function(){o.close()},100)});s.on("focus",this.onFocus=function(){clearTimeout(b)})}var x=s.getScrollInfo();s.on("scroll",this.onScroll=function(){var t=s.getScrollInfo(),e=s.getWrapperElement().getBoundingClientRect();var i=u+x.top-t.top;var n=i-(window.pageYOffset||(document.documentElement||document.body).scrollTop);if(!d)n+=r.offsetHeight;if(n<=e.top||n>=e.bottom)return o.close();r.style.top=i+"px";r.style.left=a+x.left-t.left+"px"});k.on(r,"dblclick",function(t){var e=S(r,t.target||t.srcElement);if(e&&e.hintId!=null){i.changeActive(e.hintId);i.pick()}});k.on(r,"click",function(t){var e=S(r,t.target||t.srcElement);if(e&&e.hintId!=null){i.changeActive(e.hintId);if(o.options.completeOnSingleClick)i.pick()}});k.on(r,"mousedown",function(){setTimeout(function(){s.focus()},20)});k.signal(t,"select",e[0],r.firstChild);return true}m.prototype={close:function(){if(this.completion.widget!=this)return;this.completion.widget=null;this.hints.parentNode.removeChild(this.hints);this.completion.cm.removeKeyMap(this.keyMap);var t=this.completion.cm;if(this.completion.options.closeOnUnfocus){t.off("blur",this.onBlur);t.off("focus",this.onFocus)}t.off("scroll",this.onScroll)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(t,e){if(t>=this.data.list.length)t=e?this.data.list.length-1:0;else if(t<0)t=e?0:this.data.list.length-1;if(this.selectedHint==t)return;var i=this.hints.childNodes[this.selectedHint];i.className=i.className.replace(" "+T,"");i=this.hints.childNodes[this.selectedHint=t];i.className+=" "+T;if(i.offsetTop<this.hints.scrollTop)this.hints.scrollTop=i.offsetTop-3;else if(i.offsetTop+i.offsetHeight>this.hints.scrollTop+this.hints.clientHeight)this.hints.scrollTop=i.offsetTop+i.offsetHeight-this.hints.clientHeight+3;k.signal(this.data,"select",this.data.list[this.selectedHint],i)},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}};k.registerHelper("hint","auto",function(t,e){var i=t.getHelpers(t.getCursor(),"hint"),n;if(i.length){for(var o=0;o<i.length;o++){var s=i[o](t,e);if(s&&s.list.length)return s}}else if(n=t.getHelper(t.getCursor(),"hintWords")){if(n)return k.hint.fromList(t,{words:n})}else if(k.hint.anyword){return k.hint.anyword(t,e)}});k.registerHelper("hint","fromList",function(t,e){var i=t.getCursor(),n=t.getTokenAt(i);var o=[];for(var s=0;s<e.words.length;s++){var r=e.words[s];if(r.slice(0,n.string.length)==n.string)o.push(r)}if(o.length)return{list:o,from:k.Pos(i.line,n.start),to:k.Pos(i.line,n.end)}});k.commands.autocomplete=k.showHint;var o={hint:k.hint.auto,completeSingle:true,alignWithWord:true,closeCharacters:/[\s()\[\]{};:>,]/,closeOnUnfocus:true,completeOnSingleClick:false,container:null,customKeys:null,extraKeys:null};k.defineOption("hintOptions",null)});