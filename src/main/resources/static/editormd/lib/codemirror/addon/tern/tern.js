(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../../lib/codemirror"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror"],e);else e(CodeMirror)})(function(m){"use strict";m.TernServer=function(e){var n=this;this.options=e||{};var t=this.options.plugins||(this.options.plugins={});if(!t.doc_comment)t.doc_comment=true;if(this.options.useWorker){this.server=new R(this)}else{this.server=new tern.Server({getFile:function(e,t){return a(n,e,t)},async:true,defs:this.options.defs||[],plugins:t})}this.docs=Object.create(null);this.trackChange=function(e,t){i(n,e,t)};this.cachedArgHints=null;this.activeArgHints=null;this.jumpStack=[];this.getHint=function(e,t){return r(n,e,t)};this.getHint.async=true};m.TernServer.prototype={addDoc:function(e,t){var n={doc:t,name:e,changed:null};this.server.addFile(e,O(this,n));m.on(t,"change",this.trackChange);return this.docs[e]=n},delDoc:function(e){var t=n(this,e);if(!t)return;m.off(t.doc,"change",this.trackChange);delete this.docs[t.name];this.server.delFile(t.name)},hideDoc:function(e){L(this);var t=n(this,e);if(t&&t.changed)s(this,t)},complete:function(e){e.showHint({hint:this.getHint})},showType:function(e,t,n){o(this,e,t,"type",n)},showDocs:function(e,t,n){o(this,e,t,"documentation",n)},updateArgHints:function(e){t(this,e)},jumpToDef:function(e){f(this,e)},jumpBack:function(e){u(this,e)},rename:function(e){v(this,e)},selectName:function(e){w(this,e)},request:function(e,n,i,t){var r=this;var o=c(this,e.getDoc());var a=k(this,o,n,t);this.server.request(a,function(e,t){if(!e&&r.options.responseFilter)t=r.options.responseFilter(o,n,a,e,t);i(e,t)})},destroy:function(){if(this.worker){this.worker.terminate();this.worker=null}}};var y=m.Pos;var h="CodeMirror-Tern-";var l=250;function a(e,t,n){var i=e.docs[t];if(i)n(O(e,i));else if(e.options.getFile)e.options.getFile(t,n);else n(null)}function c(e,t,n){for(var i in e.docs){var r=e.docs[i];if(r.doc==t)return r}if(!n)for(var o=0;;++o){i="[doc"+(o||"")+"]";if(!e.docs[i]){n=i;break}}return e.addDoc(n,t)}function n(e,t){if(typeof t=="string")return e.docs[t];if(t instanceof m)t=t.getDoc();if(t instanceof m.Doc)return c(e,t)}function i(e,t,n){var i=c(e,t);var r=e.cachedArgHints;if(r&&r.doc==t&&D(r.start,n.to)<=0)e.cachedArgHints=null;var o=i.changed;if(o==null)i.changed=o={from:n.from.line,to:n.from.line};var a=n.from.line+(n.text.length-1);if(n.from.line<o.to)o.to=o.to-(n.to.line-a);if(a>=o.to)o.to=a+1;if(o.from>n.from.line)o.from=n.from.line;if(t.lineCount()>l&&n.to-o.from>100)setTimeout(function(){if(i.changed&&i.changed.to-i.changed.from>100)s(e,i)},200)}function s(e,t){e.server.request({files:[{type:"full",name:t.name,text:O(e,t)}]},function(e){if(e)window.console.error(e);else t.changed=null})}function r(u,d,p){u.request(d,{type:"completions",types:true,docs:true,urls:true},function(e,t){if(e)return j(u,d,e);var n=[],i="";var r=t.start,o=t.end;if(d.getRange(y(r.line,r.ch-2),r)=='["'&&d.getRange(o,y(o.line,o.ch+2))!='"]')i='"]';for(var a=0;a<t.completions.length;++a){var s=t.completions[a],f=g(s.type);if(t.guess)f+=" "+h+"guess";n.push({text:s.name+i,displayText:s.name,className:f,data:s})}var c={from:r,to:o,list:n};var l=null;m.on(c,"close",function(){q(l)});m.on(c,"update",function(){q(l)});m.on(c,"select",function(e,t){q(l);var n=u.options.completionTip?u.options.completionTip(e.data):e.data.doc;if(n){l=F(t.parentNode.getBoundingClientRect().right+window.pageXOffset,t.getBoundingClientRect().top+window.pageYOffset,n);l.className+=" "+h+"hint-doc"}});p(c)})}function g(e){var t;if(e=="?")t="unknown";else if(e=="number"||e=="string"||e=="bool")t=e;else if(/^fn\(/.test(e))t="fn";else if(/^\[/.test(e))t="array";else t="object";return h+"completion "+h+"completion-"+t}function o(r,o,e,t,a){r.request(o,t,function(e,t){if(e)return j(r,o,e);if(r.options.typeTip){var n=r.options.typeTip(t)}else{var n=N("span",null,N("strong",null,t.type||"not found"));if(t.doc)n.appendChild(document.createTextNode(" — "+t.doc));if(t.url){n.appendChild(document.createTextNode(" "));var i=n.appendChild(N("a",null,"[docs]"));i.href=t.url;i.target="_blank"}}S(o,n);if(a)a()},e)}function t(n,i){L(n);if(i.somethingSelected())return;var e=i.getTokenAt(i.getCursor()).state;var t=m.innerMode(i.getMode(),e);if(t.mode.name!="javascript")return;var r=t.state.lexical;if(r.info!="call")return;var o,a=r.pos||0,s=i.getOption("tabSize");for(var f=i.getCursor().line,c=Math.max(0,f-9),l=false;f>=c;--f){var u=i.getLine(f),d=0;for(var p=0;;){var h=u.indexOf("\t",p);if(h==-1)break;d+=s-(h+d)%s-1;p=h+1}o=r.column-d;if(u.charAt(o)=="("){l=true;break}}if(!l)return;var g=y(f,o);var v=n.cachedArgHints;if(v&&v.doc==i.getDoc()&&D(g,v.start)==0)return C(n,i,a);n.request(i,{type:"type",preferFunction:true,end:g},function(e,t){if(e||!t.type||!/^fn\(/.test(t.type))return;n.cachedArgHints={start:p,type:x(t.type),name:t.exprName||t.name||"fn",guess:t.guess,doc:i.getDoc()};C(n,i,a)})}function C(e,t,n){L(e);var i=e.cachedArgHints,r=i.type;var o=N("span",i.guess?h+"fhint-guess":null,N("span",h+"fname",i.name),"(");for(var a=0;a<r.args.length;++a){if(a)o.appendChild(document.createTextNode(", "));var s=r.args[a];o.appendChild(N("span",h+"farg"+(a==n?" "+h+"farg-current":""),s.name||"?"));if(s.type!="?"){o.appendChild(document.createTextNode(": "));o.appendChild(N("span",h+"type",s.type))}}o.appendChild(document.createTextNode(r.rettype?") -> ":")"));if(r.rettype)o.appendChild(N("span",h+"type",r.rettype));var f=t.cursorCoords(null,"page");e.activeArgHints=F(f.right+1,f.bottom,o)}function x(r){var e=[],o=3;function t(e){var t=0,n=o;for(;;){var i=r.charAt(o);if(e.test(i)&&!t)return r.slice(n,o);if(/[{\[\(]/.test(i))++t;else if(/[}\]\)]/.test(i))--t;++o}}if(r.charAt(o)!=")")for(;;){var n=r.slice(o).match(/^([^, \(\[\{]+): /);if(n){o+=n[0].length;n=n[1]}e.push({name:n,type:t(/[\),]/)});if(r.charAt(o)==")")break;o+=2}var i=r.slice(o).match(/^\) -> (.*)$/);return{args:e,rettype:i&&i[1]}}function f(o,a){function t(e){var t={type:"definition",variable:e||null};var r=c(o,a.getDoc());o.server.request(k(o,r,t),function(e,t){if(e)return j(o,a,e);if(!t.file&&t.url){window.open(t.url);return}if(t.file){var n=o.docs[t.file],i;if(n&&(i=p(n.doc,t))){o.jumpStack.push({file:r.name,start:a.getCursor("from"),end:a.getCursor("to")});d(o,r,n,i.start,i.end);return}}j(o,a,"Could not find a definition.")})}if(!e(a))H(a,"Jump to variable",function(e){if(e)t(e)});else t()}function u(e,t){var n=e.jumpStack.pop(),i=n&&e.docs[n.file];if(!i)return;d(e,c(e,t.getDoc()),i,n.start,n.end)}function d(e,t,n,i,r){n.doc.setSelection(i,r);if(t!=n&&e.options.switchToDoc){L(e);e.options.switchToDoc(n.name,n.doc)}}function p(e,t){var n=t.context.slice(0,t.contextOffset).split("\n");var i=t.start.line-(n.length-1);var r=y(i,(n.length==1?t.start.ch:e.getLine(i).length)-n[0].length);var o=e.getLine(i).slice(r.ch);for(var a=i+1;a<e.lineCount()&&o.length<t.context.length;++a)o+="\n"+e.getLine(a);if(o.slice(0,t.context.length)==t.context)return t;var s=e.getSearchCursor(t.context,0,false);var f,c=Infinity;while(s.findNext()){var l=s.from(),u=Math.abs(l.line-r.line)*1e4;if(!u)u=Math.abs(l.ch-r.ch);if(u<c){f=l;c=u}}if(!f)return null;if(n.length==1)f.ch+=n[0].length;else f=y(f.line+(n.length-1),n[n.length-1].length);if(t.start.line==t.end.line)var d=y(f.line,f.ch+(t.end.ch-t.start.ch));else var d=y(f.line+(t.end.line-t.start.line),t.end.ch);return{start:f,end:d}}function e(e){var t=e.getCursor("end"),n=e.getTokenAt(t);if(n.start<t.ch&&(n.type=="comment"||n.type=="string"))return false;return/\w/.test(e.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}function v(n,i){var e=i.getTokenAt(i.getCursor());if(!/\w/.test(e.string))return j(n,i,"Not at a variable");H(i,"New name for "+e.string,function(e){n.request(i,{type:"rename",newName:e,fullDocs:true},function(e,t){if(e)return j(n,i,e);T(n,t.changes)})})}function w(a,s){var f=c(a,s.doc).name;a.request(s,{type:"refs"},function(e,t){if(e)return j(a,s,e);var n=[],i=0;for(var r=0;r<t.refs.length;r++){var o=t.refs[r];if(o.file==f){n.push({anchor:o.start,head:o.end});if(D(i,o.start)>=0&&D(i,o.end)<=0)i=n.length-1}}s.setSelections(n,i)})}var b=0;function T(e,t){var n=Object.create(null);for(var i=0;i<t.length;++i){var r=t[i];(n[r.file]||(n[r.file]=[])).push(r)}for(var o in n){var a=e.docs[o],s=n[o];if(!a)continue;s.sort(function(e,t){return D(t.start,e.start)});var f="*rename"+ ++b;for(var i=0;i<s.length;++i){var r=s[i];a.doc.replaceRange(r.text,r.start,r.end,f)}}}function k(e,t,n,i){var r=[],o=0,a=!n.fullDocs;if(!a)delete n.fullDocs;if(typeof n=="string")n={type:n};n.lineCharPositions=true;if(n.end==null){n.end=i||t.doc.getCursor("end");if(t.doc.somethingSelected())n.start=t.doc.getCursor("start")}var s=n.start||n.end;if(t.changed){if(t.doc.lineCount()>l&&a!==false&&t.changed.to-t.changed.from<100&&t.changed.from<=s.line&&t.changed.to>n.end.line){r.push(A(t,s,n.end));n.file="#0";var o=r[0].offsetLines;if(n.start!=null)n.start=y(n.start.line- -o,n.start.ch);n.end=y(n.end.line-o,n.end.ch)}else{r.push({type:"full",name:t.name,text:O(e,t)});n.file=t.name;t.changed=null}}else{n.file=t.name}for(var f in e.docs){var c=e.docs[f];if(c.changed&&c!=t){r.push({type:"full",name:c.name,text:O(e,c)});c.changed=null}}return{query:n,files:r}}function A(e,t,n){var i=e.doc;var r=null,o=null,a,s=4;for(var f=t.line-1,c=Math.max(0,f-50);f>=c;--f){var l=i.getLine(f),u=l.search(/\bfunction\b/);if(u<0)continue;var d=m.countColumn(l,null,s);if(r!=null&&r<=d)continue;r=d;o=f}if(o==null)o=c;var p=Math.min(i.lastLine(),n.line+20);if(r==null||r==m.countColumn(i.getLine(t.line),null,s))a=p;else for(a=n.line+1;a<p;++a){var d=m.countColumn(i.getLine(a),null,s);if(d<=r)break}var h=y(o,0);return{type:"part",name:e.name,offsetLines:h.line,text:i.getRange(h,y(a,0))}}var D=m.cmpPos;function N(e,t){var n=document.createElement(e);if(t)n.className=t;for(var i=2;i<arguments.length;++i){var r=arguments[i];if(typeof r=="string")r=document.createTextNode(r);n.appendChild(r)}return n}function H(e,t,n){if(e.openDialog)e.openDialog(t+": <input type=text>",n);else n(prompt(t,""))}function S(e,t){if(e.state.ternTooltip)q(e.state.ternTooltip);var n=e.cursorCoords();var i=e.state.ternTooltip=F(n.right+1,n.bottom,t);function r(){s=true;if(!a)o()}function o(){e.state.ternTooltip=null;if(!i.parentNode)return;e.off("cursorActivity",o);e.off("blur",o);e.off("scroll",o);M(i)}var a=false,s=false;m.on(i,"mousemove",function(){a=true});m.on(i,"mouseout",function(e){if(!m.contains(i,e.relatedTarget||e.toElement)){if(s)o();else a=false}});setTimeout(r,1700);e.on("cursorActivity",o);e.on("blur",o);e.on("scroll",o)}function F(e,t,n){var i=N("div",h+"tooltip",n);i.style.left=e+"px";i.style.top=t+"px";document.body.appendChild(i);return i}function q(e){var t=e&&e.parentNode;if(t)t.removeChild(e)}function M(e){e.style.opacity="0";setTimeout(function(){q(e)},1100)}function j(e,t,n){if(e.options.showError)e.options.showError(t,n);else S(t,String(n))}function L(e){if(e.activeArgHints){q(e.activeArgHints);e.activeArgHints=null}}function O(e,t){var n=t.doc.getValue();if(e.options.fileFilter)n=e.options.fileFilter(n,t.name,t.doc);return n}function R(t){var n=t.worker=new Worker(t.options.workerScript);n.postMessage({type:"init",defs:t.options.defs,plugins:t.options.plugins,scripts:t.options.workerDeps});var i=0,r={};function o(e,t){if(t){e.id=++i;r[i]=t}n.postMessage(e)}n.onmessage=function(e){var n=e.data;if(n.type=="getFile"){a(t,n.name,function(e,t){o({type:"getFile",err:String(e),text:t,id:n.id})})}else if(n.type=="debug"){window.console.log(n.message)}else if(n.id&&r[n.id]){r[n.id](n.err,n.body);delete r[n.id]}};n.onerror=function(e){for(var t in r)r[t](e);r={}};this.addFile=function(e,t){o({type:"add",name:e,text:t})};this.delFile=function(e){o({type:"del",name:e})};this.request=function(e,t){o({type:"req",body:e},t)}}});