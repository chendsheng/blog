(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../../lib/codemirror"),require("../fold/xml-fold"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror","../fold/xml-fold"],e);else e(CodeMirror)})(function(v){v.defineOption("autoCloseTags",false,function(e,t,n){if(n!=v.Init&&n)e.removeKeyMap("autoCloseTags");if(!t)return;var r={name:"autoCloseTags"};if(typeof t!="object"||t.whenClosing)r["'/'"]=function(e){return o(e)};if(typeof t!="object"||t.whenOpening)r["'>'"]=function(e){return a(e)};e.addKeyMap(r)});var b=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];var y=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];function a(e){if(e.getOption("disableInput"))return v.Pass;var t=e.listSelections(),n=[];for(var r=0;r<t.length;r++){if(!t[r].empty())return v.Pass;var a=t[r].head,o=e.getTokenAt(a);var i=v.innerMode(e.getMode(),o.state),s=i.state;if(i.mode.name!="xml"||!s.tagName)return v.Pass;var l=e.getOption("autoCloseTags"),f=i.mode.configuration=="html";var c=typeof l=="object"&&l.dontCloseTags||f&&b;var d=typeof l=="object"&&l.indentTags||f&&y;var g=s.tagName;if(o.end>a.ch)g=g.slice(0,g.length-o.end+a.ch);var u=g.toLowerCase();if(!g||o.type=="string"&&(o.end!=a.ch||!/[\"\']/.test(o.string.charAt(o.string.length-1))||o.string.length==1)||o.type=="tag"&&s.type=="closeTag"||o.string.indexOf("/")==o.string.length-1||c&&x(c,u)>-1||P(e,g,a,s,true))return v.Pass;var m=d&&x(d,u)>-1;n[r]={indent:m,text:">"+(m?"\n\n":"")+"</"+g+">",newPos:m?v.Pos(a.line+1,0):v.Pos(a.line,a.ch+1)}}for(var r=t.length-1;r>=0;r--){var h=n[r];e.replaceRange(h.text,t[r].head,t[r].anchor,"+insert");var p=e.listSelections().slice(0);p[r]={head:h.newPos,anchor:h.newPos};e.setSelections(p);if(h.indent){e.indentLine(h.newPos.line,null,true);e.indentLine(h.newPos.line+1,null,true)}}}function t(e,t){var n=e.listSelections(),r=[];var a=t?"/":"</";for(var o=0;o<n.length;o++){if(!n[o].empty())return v.Pass;var i=n[o].head,s=e.getTokenAt(i);var l=v.innerMode(e.getMode(),s.state),f=l.state;if(t&&(s.type=="string"||s.string.charAt(0)!="<"||s.start!=i.ch-1))return v.Pass;if(l.mode.name!="xml"){if(e.getMode().name=="htmlmixed"&&l.mode.name=="javascript")r[o]=a+"script>";else if(e.getMode().name=="htmlmixed"&&l.mode.name=="css")r[o]=a+"style>";else return v.Pass}else{if(!f.context||!f.context.tagName||P(e,f.context.tagName,i,f))return v.Pass;r[o]=a+f.context.tagName+">"}}e.replaceSelections(r);n=e.listSelections();for(var o=0;o<n.length;o++)if(o==n.length-1||n[o].head.line<n[o+1].head.line)e.indentLine(n[o].head.line)}function o(e){if(e.getOption("disableInput"))return v.Pass;return t(e,true)}v.commands.closeTag=function(e){return t(e)};function x(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,r=e.length;n<r;++n)if(e[n]==t)return n;return-1}function P(e,t,n,r,a){if(!v.scanForClosingTag)return false;var o=Math.min(e.lastLine()+1,n.line+500);var i=v.scanForClosingTag(e,n,null,o);if(!i||i.tag!=t)return false;var s=r.context;for(var l=a?1:0;s&&s.tagName==t;s=s.prev)++l;n=i.to;for(var f=1;f<l;f++){var c=v.scanForClosingTag(e,n,null,o);if(!c||c.tag!=t)return false;n=c.to}return true}});