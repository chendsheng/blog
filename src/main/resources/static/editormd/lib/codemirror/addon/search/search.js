(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e);else e(CodeMirror)})(function(t){"use strict";function i(o,e){if(typeof o=="string")o=new RegExp(o.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e?"gi":"g");else if(!o.global)o=new RegExp(o.source,o.ignoreCase?"gi":"g");return{token:function(e){o.lastIndex=e.pos;var r=o.exec(e.string);if(r&&r.index==e.pos){e.pos+=r[0].length;return"searching"}else if(r){e.pos=r.index}else{e.skipToEnd()}}}}function r(){this.posFrom=this.posTo=this.query=null;this.overlay=null}function a(e){return e.state.search||(e.state.search=new r)}function c(e){return typeof e=="string"&&e==e.toLowerCase()}function s(e,r,o){return e.getSearchCursor(r,o,c(r))}function f(e,r,o,n,t){if(e.openDialog)e.openDialog(r,t,{value:n});else t(prompt(o,n))}function l(e,r,o,n){if(e.openConfirm)e.openConfirm(r,n);else if(confirm(o))n[0]()}function u(e){var r=e.match(/^\/(.*)\/([a-z]*)$/);if(r){try{e=new RegExp(r[1],r[2].indexOf("i")==-1?"":"i")}catch(e){}}if(typeof e=="string"?e=="":e.test(""))e=/x^/;return e}var e='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';function o(r,o){var n=a(r);if(n.query)return p(r,o);f(r,e,"Search for:",r.getSelection(),function(e){r.operation(function(){if(!e||n.query)return;n.query=u(e);r.removeOverlay(n.overlay,c(n.query));n.overlay=i(n.query,c(n.query));r.addOverlay(n.overlay);if(r.showMatchesOnScrollbar){if(n.annotate){n.annotate.clear();n.annotate=null}n.annotate=r.showMatchesOnScrollbar(n.query,c(n.query))}n.posFrom=n.posTo=r.getCursor();p(r,o)})})}function p(o,n){o.operation(function(){var e=a(o);var r=s(o,e.query,n?e.posFrom:e.posTo);if(!r.find(n)){r=s(o,e.query,n?t.Pos(o.lastLine()):t.Pos(o.firstLine(),0));if(!r.find(n))return}o.setSelection(r.from(),r.to());o.scrollIntoView({from:r.from(),to:r.to()});e.posFrom=r.from();e.posTo=r.to()})}function d(r){r.operation(function(){var e=a(r);if(!e.query)return;e.query=null;r.removeOverlay(e.overlay);if(e.annotate){e.annotate.clear();e.annotate=null}})}var n='Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';var m='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>';var y="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";function h(a,e){if(a.getOption("readOnly"))return;f(a,n,"Replace:",a.getSelection(),function(i){if(!i)return;i=u(i);f(a,m,"Replace with:","",function(r){if(e){a.operation(function(){for(var e=s(a,i);e.findNext();){if(typeof i!="string"){var o=a.getRange(e.from(),e.to()).match(i);e.replace(r.replace(/\$(\d)/g,function(e,r){return o[r]}))}else e.replace(r)}})}else{d(a);var n=s(a,i,a.getCursor());var t=function(){var e=n.from(),r;if(!(r=n.findNext())){n=s(a,i);if(!(r=n.findNext())||e&&n.from().line==e.line&&n.from().ch==e.ch)return}a.setSelection(n.from(),n.to());a.scrollIntoView({from:n.from(),to:n.to()});l(a,y,"Replace?",[function(){o(r)},t])};var o=function(o){n.replace(typeof i=="string"?r:r.replace(/\$(\d)/g,function(e,r){return o[r]}));t()};t()}})})}t.commands.find=function(e){d(e);o(e)};t.commands.findNext=o;t.commands.findPrev=function(e){o(e,true)};t.commands.clearSearch=d;t.commands.replace=h;t.commands.replaceAll=function(e){h(e,true)}});